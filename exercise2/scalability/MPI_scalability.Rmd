---
title: "MPI Scalability"
author: Giulio Fantuzzi
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
library(tidyverse)
library(ggplot2)
```

# How does OMP_NUM_THREADS impact?
For this analysis we have an overall size fixed to $N=240.000.000$ bytes
## OMP_NUM_THREADS=1
Import and prepare data:
```{r}
mpi_timings_1<- read.csv("../timings/hybrid_scaling_240M_1thread.csv")

mpi_timings_1<- mpi_timings_1 %>% 
                select(!Threads) %>%
                group_by(Processes) %>%
                summarise(Time = mean(Time, na.rm = TRUE))

mpi_timings_1$SpeedUp<- mpi_timings_1$Time[1] / mpi_timings_1$Time
mpi_timings_1$OMP_NUM_THREADS<- "1 Thread"
```

On original scale:

```{r,echo=FALSE}
mpi_timings_1 %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="indianred1") +
  geom_point(size=2)+
    labs(title = "Time vs MPI Processes (Size=240M ; OMP_NUM_THREADS=1)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```
On logarithmic scale:

```{r,echo=FALSE}
mpi_timings_1 %>%
  ggplot(aes(x = log2(Processes), y = log2(Time))) +
  geom_vline(xintercept = 1:6, linetype = "dashed", color = "grey")+
  annotate("text", x = 1:6, y = rep(0,6), label = 1:6, 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="indianred1") +
  geom_point(size=2)+
    labs(title = "log2(Time) vs log2(MPI Processes) (Size=240M ; OMP_NUM_THREADS=1)",
         x = "log2(Processes)",
         y = "log2(Time)") +
    theme_minimal()
```

## OMP_NUM_THREADS=2

Import and prepare data:
```{r}
mpi_timings_2<- read.csv("../timings/hybrid_scaling_240M_2threads.csv")

mpi_timings_2<- mpi_timings_2 %>% 
                select(!Threads) %>%
                group_by(Processes) %>%
                summarise(Time = mean(Time, na.rm = TRUE))

mpi_timings_2$SpeedUp<- mpi_timings_2$Time[1] / mpi_timings_2$Time
mpi_timings_2$OMP_NUM_THREADS<- "2 Threads"
```

On original scale:

```{r,echo=FALSE}
mpi_timings_2 %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="blue3") +
  geom_point(size=2)+
    labs(title = "Time vs MPI Processes (Size=240M ; OMP_NUM_THREADS=2)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```
On logarithmic scale:

```{r,echo=FALSE}
mpi_timings_2 %>%
  ggplot(aes(x = log2(Processes), y = log2(Time))) +
  geom_vline(xintercept = 1:6, linetype = "dashed", color = "grey")+
  annotate("text", x = 1:6, y = rep(0,6), label = 1:6, 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="blue3") +
  geom_point(size=2)+
    labs(title = "log2(Time) vs log2(MPI Processes) (Size=240M ; OMP_NUM_THREADS=2)",
         x = "log2(Processes)",
         y = "log2(Time)") +
    theme_minimal()
```

## OMP_NUM_THREADS=4

Import and prepare data:
```{r}
mpi_timings_4<- read.csv("../timings/hybrid_scaling_240M_4threads.csv")

mpi_timings_4<- mpi_timings_4 %>% 
                select(!Threads) %>%
                group_by(Processes) %>%
                summarise(Time = mean(Time, na.rm = TRUE))

mpi_timings_4$SpeedUp<- mpi_timings_4$Time[1] / mpi_timings_4$Time
mpi_timings_4$OMP_NUM_THREADS<- "4 Threads"
```

On original scale:

```{r,echo=FALSE}
mpi_timings_4 %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="green4") +
  geom_point(size=2)+
    labs(title = "Time vs MPI Processes (Size=240M ; OMP_NUM_THREADS=4)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```
On logarithmic scale:

```{r,echo=FALSE}
mpi_timings_4 %>%
  ggplot(aes(x = log2(Processes), y = log2(Time))) +
  geom_vline(xintercept = 1:6, linetype = "dashed", color = "grey")+
  annotate("text", x = 1:6, y = rep(0,6), label = 1:6, 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="blue3") +
  geom_point(size=2)+
    labs(title = "log2(Time) vs log2(MPI Processes) (Size=240M ; OMP_NUM_THREADS=4)",
         x = "log2(Processes)",
         y = "log2(Time)") +
    theme_minimal()
```

## OMP_NUM_THREADS=8

Import and prepare data:
```{r}
mpi_timings_8<- read.csv("../timings/hybrid_scaling_240M_8threads.csv")

mpi_timings_8<- mpi_timings_8 %>% 
                select(!Threads) %>%
                group_by(Processes) %>%
                summarise(Time = mean(Time, na.rm = TRUE))

mpi_timings_8$SpeedUp<- mpi_timings_8$Time[1] / mpi_timings_8$Time
mpi_timings_8$OMP_NUM_THREADS<- "8 Threads"
```

On original scale:

```{r,echo=FALSE}
mpi_timings_8 %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="orange3") +
  geom_point(size=2)+
    labs(title = "Time vs MPI Processes (Size=240M ; OMP_NUM_THREADS=8)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```
On logarithmic scale:

```{r,echo=FALSE}
mpi_timings_8 %>%
  ggplot(aes(x = log2(Processes), y = log2(Time))) +
  geom_vline(xintercept = 1:6, linetype = "dashed", color = "grey")+
  annotate("text", x = 1:6, y = rep(0,6), label = 1:6, 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="orange3") +
  geom_point(size=2)+
    labs(title = "log2(Time) vs log2(MPI Processes) (Size=240M ; OMP_NUM_THREADS=8)",
         x = "log2(Processes)",
         y = "log2(Time)") +
    theme_minimal()
```

## Time Comparison

On original scale

```{r,echo=FALSE,fig.width=10}
df= rbind(mpi_timings_1,mpi_timings_2,mpi_timings_4,mpi_timings_8)
df %>%
  ggplot(aes(x = Processes, y = Time, color = OMP_NUM_THREADS)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey60")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey60")+
  geom_point(size=1)+
  geom_line(size=0.6) +
  scale_color_manual(values = c("#3498DB","#E67E22","#82CD47","red")) +
  labs(title = "Time vs MPI processes (SIZE= 240M size_t varying OMP_NUM_THREADS_NUM_THREADS)",
       x = "MPI processes",
       y = "Time") +
  #ylim(0,10)+
  theme_minimal()
```
On logarithmic scale:

```{r,echo=F,fig.width=10}
df= rbind(mpi_timings_1,mpi_timings_2,mpi_timings_4,mpi_timings_8)
df %>%
  ggplot(aes(x = log2(Processes), y = log2(Time), color = OMP_NUM_THREADS)) +
  geom_vline(xintercept =1:6, linetype = "dashed", color = "grey60")+
  annotate("text", x = 1:6, y = rep(0,6), label = 1:6, 
           vjust = 0, hjust = -0.1,color="grey60")+
  geom_point(size=1)+
  geom_line(size=0.6) +
  scale_color_manual(values = c("#3498DB","#E67E22","#82CD47","red")) +
  labs(title = "log2(Time) vs log2(MPI processes) (SIZE= 240M size_t varying OMP_NUM_THREADS_NUM_THREADS)",
       x = "log2(MPI processes)",
       y = "log2(Time)") +
  #ylim(0,10)+
  theme_minimal()
```

# Speedup

Take into consideration the speedup for the hybrid approach with OMP_NUM_THREADS=4:

```{r,echo=F}
mpi_timings_4 %>%
  ggplot(aes(x = Processes, y = SpeedUp)) +
  geom_point(size=1.5)+
  geom_line(size=0.6) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64),
           vjust = 0, hjust = -0.1,color="grey")+
  #geom_function(fun = function(x) log2(x), linetype = "dashed", col = "blue",size=0.6)+
  labs(title = "MPI SpeedUp",
       x = "Processes",
       y = "SpeedUp") +
  theme_minimal()
```

```{r}
mpi_timings_4 %>%
  ggplot(aes(x = log2(Processes), y = log2(SpeedUp))) +
  geom_point(size=1.5)+
  geom_line(size=0.6) +
  geom_vline(xintercept = 1:6, linetype = "dashed", color = "grey")+
  annotate("text", x = 1:6, y = rep(0,6), label = 1:6,
           vjust = 0, hjust = -0.1,color="grey")+
  #geom_function(fun = function(x) sqrt(x), linetype = "dashed", col = "blue",size=0.6)+
  labs(title = "log2(MPI SpeedUp)",
       x = "log2(Processes)",
       y = "log2(SpeedUp)") +
  theme_minimal()
```

# MPI strong scalability

It is basically what we did before, but now we considered a smaller size:

```{r}
mpi_strong.df<- read.csv("../timings/MPI_strong_160M.csv")
mpi_strong.df<- mpi_strong.df %>% 
                select(!Threads) %>%
                group_by(Processes) %>%
                summarise(Time = min(Time, na.rm = TRUE))
```

```{r,echo=F}
mpi_strong.df %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="orange3") +
  geom_point(size=1)+
    labs(title = "Time vs MPI Processes (Size=160M ; OMP_NUM_THREADS=4)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```

Notice how the odd number of processes influence negatively the sorting time

```{r,echo=F}
mpi_strong.df %>% filter((Processes%%2==0) | (Processes==1)) %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0, hjust = -0.1,color="grey50")+
  geom_line(col="orange3") +
  geom_point(size=1)+
    labs(title = "Time vs MPI Processes (Size=160M ; OMP_NUM_THREADS=4)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```
Speedup:

```{r}
mpi_strong.df$SpeedUp<- mpi_strong.df$Time[1] / mpi_strong.df$Time
```


```{r,echo=F}
mpi_strong.df %>%
ggplot(aes(x = Processes, y = SpeedUp)) +
  geom_point(size=1.5)+
  geom_line(size=0.6) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64),
           vjust = 0, hjust = -0.1,color="grey")+
  #geom_function(fun = function(x) log2(x)+1, linetype = "dashed", col = "red",size=0.6)+
  labs(title = "MPI SpeedUp",
       x = "Processes",
       y = "SpeedUp") +
  theme_minimal()
```

# MPI weak scalability

```{r}
mpi_weak.df<- read.csv("../timings/MPI_weak_160M.csv")
mpi_weak.df<- mpi_weak.df %>% 
                select(!Threads) %>%
                group_by(Processes) %>%
                summarise(Time = min(Time, na.rm = TRUE))
```


```{r}
mpi_weak.df %>% 
  #filter((Processes%%2==0) | (Processes==1)) %>%
  ggplot(aes(x = Processes, y = Time)) +
  geom_vline(xintercept = c(2,4,8,16,32,64), linetype = "dashed", color = "grey")+
  annotate("text", x = c(2,4,8,16,32,64), y = rep(0,6), label = c(2,4,8,16,32,64), 
           vjust = 0.7, hjust = -0.3,color="grey50")+
  geom_line(col="lightblue3") +
  geom_hline(yintercept = mpi_weak.df$Time[1]*8,linetype="solid",color="navy",size=0.3)+
  annotate("text", x = 50, y = 5, label = "8 times serial", color="navy")+
  geom_hline(yintercept = mpi_weak.df$Time[1]*64,linetype="solid",color="red3",size=0.3)+
  annotate("text", x = 50, y = 33, label = "64 times serial(worst-case-scenario)", color="red3")+
  geom_point(size=0.6)+
    labs(title = "WEAK SCALABILITY (Workload-pp=2.5M ; OMP_NUM_THREADS=4)",
         x = "Processes",
         y = "Time") +
    theme_minimal()
```

